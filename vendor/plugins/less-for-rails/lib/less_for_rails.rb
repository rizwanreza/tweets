require 'fileutils'
module LessForRails
  HEADER = %{/*
 This file was auto generated by Less (http://lesscss.org), using
 the less-for-rails plugin (http://github.com/augustl/less-for-rails).
 
 To change the contents of this file, edit %s instead.
*/

}

  extend self

  # Add aditional paths where the plugin should be looking for .less files
  # with `LessForRails.paths << "my/path/here"`.
  def paths
    @paths ||= ["#{Rails.root}/public/stylesheets"]
  end

  # Converts all *.less files in +paths+ to STYLESHEETS_PATH/[filename].css.
  #
  # Options:
  #  compress - Remove all newlines? `true` or `false`.
  def run(options = {})
    paths.each do |path|
      Dir.chdir(path) do
        Dir["**/*.less"].each do |less_sheet|
          directory = File.dirname(less_sheet)
          target_filename = File.basename(less_sheet, File.extname(less_sheet)) + ".css"
          destination = "#{directory}/#{target_filename}"
          
          if !File.exists?(destination) || File.stat(less_sheet).mtime > File.stat(destination).mtime
            engine = File.open(less_sheet) {|f| Less::Engine.new(f) }
            css = engine.to_css
            css.delete("\n") if options[:compress]
            
            FileUtils.mkdir_p(directory)
            File.open(destination, "w") {|file|
              file.write HEADER % [path + "/" + less_sheet] if Rails.env == "development"
              file.write css
            }
          end
        end
      end # chdir
    end # each
  end # run
end